name: Snapshot Release

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  build-snapshot:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v5

    - uses: actions/setup-java@v5
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Build APK
      run: |
        ./gradlew :app:assembleRelease \
          -PversionCode=$(git rev-list --count HEAD) \
          -PversionName="snapshot-pr${{ github.event.pull_request.number }}-${{ github.sha }}" \
          -PsnapshotBuild=true

    - name: Store APK in temporary storage
      uses: actions/upload-artifact@v4
      with:
        name: snapshot-apk-pr-${{ github.event.pull_request.number }}
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 7

    - name: Comment PR with APK download link
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const runId = context.runId;
          const repoOwner = context.repo.owner;
          const repoName = context.repo.repo;
          const commitSha = context.sha.substring(0, 7);

          const downloadUrl = `https://github.com/${repoOwner}/${repoName}/actions/runs/${runId}`;

          const comment = `## ðŸ“± Snapshot APK Ready

          A preview APK has been built for this PR:

          **ðŸ“¥ Download:** [snapshot-apk-pr-${prNumber}](${downloadUrl})

          **ðŸ“¦ Version:** \`snapshot-pr${prNumber}-${context.sha}\`
          **ðŸ”— Commit:** ${commitSha}
          **â° Available for:** 7 days

          To download:
          1. Click the download link above
          2. Go to "Artifacts" section
          3. Download \`snapshot-apk-pr-${prNumber}\``;

          // Find and update existing comment or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });

          const existingComment = comments.find(comment =>
            comment.body.includes('## ðŸ“± Snapshot APK Ready')
          );

          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
          }
